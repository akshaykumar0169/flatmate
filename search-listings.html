<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Flatmates | Flatmate Finder</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 0;
        }

        .search-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
        }

        .search-header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .search-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .search-header p {
            margin: 0;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .filters-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .filters-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #4CAF50;
            background: white;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .preferences-container {
            grid-column: 1 / -1;
        }

        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .preference-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .preference-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4CAF50;
        }

        .preference-item label {
            margin: 0;
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #388e3c;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .results-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sort-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .listing-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .listing-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .listing-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: #4CAF50;
            margin: 0;
        }

        .listing-images {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .listing-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .listing-image:hover {
            transform: scale(1.05);
        }

        .listing-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        .detail-icon {
            width: 16px;
            height: 16px;
            color: #4CAF50;
        }

        .listing-location {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .listing-preferences {
            margin-bottom: 15px;
        }

        .pref-tag {
            display: inline-block;
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
            font-weight: 500;
        }

        .listing-notes {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .listing-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .btn-contact {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }

        .btn-contact:hover {
            background: #1976D2;
        }

        .btn-save {
            background: #FF9800;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-save:hover {
            background: #F57C00;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.2rem;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .no-results-icon {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .no-results h3 {
            color: #666;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .search-container {
                margin: 20px;
                padding: 15px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .listings-grid {
                grid-template-columns: 1fr;
            }

            .search-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <a href="user-dashboard.html" class="logo">
                <span class="home-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                        class="bi bi-house-door-fill" viewBox="0 0 16 16">
                        <path
                            d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5" />
                    </svg>
                </span>
                <span class="logo-text">Flatmate <span class="logo-text">Finder</span></span>
            </a>
        </div>
        <ul id="navbar-links">
            <li id="profile-menu" class="profile-menu">
                <a href="user-dashboard.html" id="profile-icon" class="profile-icon">üë§</a>
            </li>
        </ul>
    </nav>

    <div class="search-container">
        <div class="search-header">
            <h1>üîç Find Your Perfect Flatmate</h1>
            <p>Search through available listings with smart filters</p>
        </div>

        <!-- Search Filters -->
        <div class="filters-container">
            <h2 class="filters-title">Search Filters</h2>

            <div class="filters-grid">
                <!-- Location Filters -->
                <div class="filter-group">
                    <label for="state">State</label>
                    <select id="state">
                        <option value="">All States</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="West Bengal">West Bengal</option>
                        <option value="Uttar Pradesh">Uttar Pradesh</option>
                        <option value="Punjab">Punjab</option>
                        <option value="Haryana">Haryana</option>
                        <option value="Kerala">Kerala</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="city">City</label>
                    <input type="text" id="city" placeholder="Enter city name">
                </div>

                <div class="filter-group">
                    <label for="location">Area/Location</label>
                    <input type="text" id="location" placeholder="Specific area or locality">
                </div>

                <!-- Budget Filters -->
                <div class="filter-group">
                    <label for="minPrice">Min Budget (‚Çπ)</label>
                    <input type="number" id="minPrice" placeholder="5000" min="0">
                </div>

                <div class="filter-group">
                    <label for="maxPrice">Max Budget (‚Çπ)</label>
                    <input type="number" id="maxPrice" placeholder="50000" min="0">
                </div>

                <!-- Other Filters -->
                <div class="filter-group">
                    <label for="furnishing">Furnishing</label>
                    <select id="furnishing">
                        <option value="">Any</option>
                        <option value="Fully Furnished">Fully Furnished</option>
                        <option value="Semi Furnished">Semi Furnished</option>
                        <option value="Unfurnished">Unfurnished</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="gender">Preferred Gender</label>
                    <select id="gender">
                        <option value="">Any</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>

                <!-- Preferences -->
                <div class="filter-group preferences-container">
                    <label>Preferences</label>
                    <div class="preferences-grid">
                        <div class="preference-item">
                            <input type="checkbox" id="pref-nonsmoker" value="Non-Smoker">
                            <label for="pref-nonsmoker">Non-Smoker</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-vegetarian" value="Vegetarian">
                            <label for="pref-vegetarian">Vegetarian</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-petfriendly" value="Pet Friendly">
                            <label for="pref-petfriendly">Pet Friendly</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-student" value="Student">
                            <label for="pref-student">Student</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-professional" value="Working Professional">
                            <label for="pref-professional">Working Professional</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-nightshift" value="Night Shift OK">
                            <label for="pref-nightshift">Night Shift OK</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="search-actions">
                <button class="btn btn-primary" onclick="searchListings()">üîç Search Flatmates</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>
                <a href="post-requirement.html" class="btn btn-primary">‚ûï Post Your Requirement</a>
            </div>
        </div>

        <!-- Search Results -->
        <div class="results-container" id="resultsContainer" style="display: none;">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Found 0 listings</div>
                <div class="sort-controls">
                    <label for="sortBy">Sort by:</label>
                    <select id="sortBy" onchange="sortResults()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                    </select>
                </div>
            </div>

            <div id="loadingState" class="loading" style="display: none;">
                <div>üîÑ Searching for flatmates...</div>
            </div>

            <div id="listingsGrid" class="listings-grid">
                <!-- Listings will be populated here -->
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                <div class="no-results-icon">üòî</div>
                <h3>No flatmates found</h3>
                <p>Try adjusting your search criteria or expanding your location range.</p>
                <button class="btn btn-primary" onclick="clearFilters()">Clear All Filters</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Flatmate Finder. All rights reserved.</p>
    </footer>

   <script>
        let allListings = [];
        let filteredListings = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadAllListings();
        });

        async function loadAllListings() {
            try {
                showLoading(true);
                const response = await fetch('/api/requirements', {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success && result.data) {
                    allListings = result.data;
                    filteredListings = [...allListings];
                    console.log(`Loaded ${allListings.length} listings`);
                } else {
                    allListings = [];
                    filteredListings = [];
                }
            } catch (error) {
                console.error('Error loading listings:', error);
                allListings = [];
                filteredListings = [];
            } finally {
                showLoading(false);
            }
        }

        function searchListings() {
            showLoading(true);
            document.getElementById('resultsContainer').style.display = 'block';

            const filters = {
                state: document.getElementById('state').value.toLowerCase(),
                city: document.getElementById('city').value.toLowerCase(),
                location: document.getElementById('location').value.toLowerCase(),
                minPrice: parseInt(document.getElementById('minPrice').value) || 0,
                maxPrice: parseInt(document.getElementById('maxPrice').value) || Infinity,
                furnishing: document.getElementById('furnishing').value,
                gender: document.getElementById('gender').value,
                preferences: getSelectedPreferences()
            };

            filteredListings = allListings.filter(listing => {
                if (filters.state && !listing.state.toLowerCase().includes(filters.state)) return false;
                if (filters.city && !listing.city.toLowerCase().includes(filters.city)) return false;
                if (filters.location && !listing.location.toLowerCase().includes(filters.location)) return false;

                const listingPrice = listing.price || 0;
                if (listingPrice < filters.minPrice || listingPrice > filters.maxPrice) return false;

                if (filters.furnishing && listing.furnishing !== filters.furnishing) return false;
                if (filters.gender && listing.gender && listing.gender !== filters.gender) return false;

                if (filters.preferences.length > 0) {
                    const listingPrefs = listing.prefs || [];
                    const hasMatchingPref = filters.preferences.some(pref =>
                        listingPrefs.some(listingPref =>
                            listingPref.toLowerCase().includes(pref.toLowerCase())
                        )
                    );
                    if (!hasMatchingPref) return false;
                }
                return true;
            });

            setTimeout(() => {
                showLoading(false);
                displayResults();
            }, 800);
        }

        function getSelectedPreferences() {
            const preferences = [];
            const checkboxes = document.querySelectorAll('.preference-item input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => preferences.push(checkbox.value));
            return preferences;
        }

        function displayResults() {
            updateResultsCount();
            if (filteredListings.length === 0) return showNoResults();

            const listingsGrid = document.getElementById('listingsGrid');
            listingsGrid.innerHTML = '';

            filteredListings.forEach(listing => {
                const card = createListingCard(listing);
                listingsGrid.appendChild(card);
            });

            document.getElementById('noResults').style.display = 'none';
            document.getElementById('listingsGrid').style.display = 'grid';
        }

        function createListingCard(listing) {
            const card = document.createElement('div');
            card.className = 'listing-card';
            const postedDate = new Date(listing.createdAt).toLocaleDateString();

            let imagesHtml = '';
            if (listing.images && listing.images.length > 0) {
                imagesHtml = `
                    <div class="listing-images">
                        ${listing.images.map(img =>
                            `<img src="${img}" alt="Property Image" class="listing-image" onclick="openImageModal('${img}')">`
                        ).join('')}
                    </div>
                `;
            }

            const preferencesHtml = listing.prefs && listing.prefs.length > 0
                ? listing.prefs.map(pref => `<span class="pref-tag">${pref}</span>`).join('')
                : '<span class="pref-tag">No specific preferences</span>';

            const notesHtml = listing.notes ? `<div class="listing-notes">${listing.notes}</div>` : '';
            const userName = listing.userId ? listing.userId.fullname : 'Unknown User';

            card.innerHTML = `
                <div class="listing-header">
                    <h3 class="listing-title">${userName}</h3>
                    <div class="listing-price">‚Çπ${listing.price || 'N/A'}</div>
                </div>
                ${imagesHtml}
                <div class="listing-location">üìç ${listing.location}, ${listing.city}, ${listing.state}</div>
                <div class="listing-details">
                    <div class="detail-item"><span>üè†</span><span>${listing.furnishing || 'Not specified'}</span></div>
                    <div class="detail-item"><span>üë§</span><span>${listing.gender || 'Any gender'}</span></div>
                    <div class="detail-item"><span>üìÖ</span><span>Posted: ${postedDate}</span></div>
                    <div class="detail-item"><span>üë®‚Äçüíº</span><span>By: ${userName}</span></div>
                </div>
                <div class="listing-preferences"><strong>Preferences:</strong><br>${preferencesHtml}</div>
                ${notesHtml}
                <div>
                    <button class="btn-save save-btn" onclick="toggleSave('${listing._id}', this)" data-post-id="${listing._id}">
                        üíæ Save
                    </button>
                    <button class="btn-contact" onclick="startChat('${listing.userId?._id}', '${userName}')">
                        üí¨ Chat
                    </button>
                </div>
            `;
            return card;
        }

        function updateResultsCount() {
            const count = filteredListings.length;
            document.getElementById('resultsCount').textContent = `Found ${count} listing${count !== 1 ? 's' : ''}`;
        }

        function sortResults() {
            const sortBy = document.getElementById('sortBy').value;
            filteredListings.sort((a, b) => {
                switch (sortBy) {
                    case 'newest': return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'oldest': return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'price-low': return (a.price || 0) - (b.price || 0);
                    case 'price-high': return (b.price || 0) - (a.price || 0);
                    default: return 0;
                }
            });
            displayResults();
        }

        function clearFilters() {
            document.getElementById('state').value = '';
            document.getElementById('city').value = '';
            document.getElementById('location').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('furnishing').value = '';
            document.getElementById('gender').value = '';
            document.querySelectorAll('.preference-item input[type="checkbox"]').forEach(cb => cb.checked = false);
            filteredListings = [...allListings];
            document.getElementById('resultsContainer').style.display = 'block';
            displayResults();
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('listingsGrid').style.display = show ? 'none' : 'grid';
            document.getElementById('noResults').style.display = 'none';
        }

        function showNoResults() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('listingsGrid').style.display = 'none';
            document.getElementById('noResults').style.display = 'block';
        }

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex;
                justify-content: center; align-items: center; z-index: 1000; cursor: pointer;
            `;
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
            modal.appendChild(img);
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }

        // ============================================================================
        // SAVED POSTS & CHAT FUNCTIONALITY
        // ============================================================================
        let currentUserId = null;

        // Get current user ID on page load
        fetch('http://localhost:3000/api/user', { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                if (data.loggedIn) {
                    currentUserId = data.userId;
                    checkSavedPosts();
                }
            })
            .catch(error => console.error('Auth check error:', error));

        // Check which posts are already saved
        async function checkSavedPosts() {
            const saveButtons = document.querySelectorAll('.save-btn');
            for (const btn of saveButtons) {
                const postId = btn.getAttribute('data-post-id');
                if (!postId) continue;
                try {
                    const response = await fetch(`http://localhost:3000/api/check-saved/${postId}`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success && data.isSaved) {
                        btn.classList.add('saved');
                        btn.innerHTML = '<i class="fas fa-bookmark"></i> Saved';
                    }
                } catch (error) {
                    console.error('Error checking saved status:', error);
                }
            }
        }

        // Toggle save/unsave post
        async function toggleSave(postId, button) {
            if (!currentUserId) {
                alert('Please login to save posts');
                window.location.href = 'login.html';
                return;
            }
            try {
                const isSaved = button.classList.contains('saved');
                const url = `http://localhost:3000/api/save-post/${postId}`;
                const method = isSaved ? 'DELETE' : 'POST';
                const response = await fetch(url, { method, credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    if (isSaved) {
                        button.classList.remove('saved');
                        button.innerHTML = '<i class="far fa-bookmark"></i> Save';
                    } else {
                        button.classList.add('saved');
                        button.innerHTML = '<i class="fas fa-bookmark"></i> Saved';
                    }
                } else {
                    alert(data.message || 'Error saving post');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Error saving post. Please try again.');
            }
        }

        // Start chat with user
        async function startChat(otherUserId, otherUserName) {
            if (!currentUserId) {
                alert('Please login to chat');
                window.location.href = 'login.html';
                return;
            }
            if (!otherUserId) {
                alert('Cannot chat with this user');
                return;
            }
            if (otherUserId === currentUserId) {
                alert('Cannot chat with yourself!');
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/api/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ otherUserId })
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = `chat.html?conversation=${data.conversation._id}`;
                } else {
                    alert('Error starting conversation. Please try again.');
                }
            } catch (error) {
                console.error('Chat error:', error);
                alert('Error starting conversation. Please try again.');
            }
        }
    </script>

</body>
</html>